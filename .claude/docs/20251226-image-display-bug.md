# 2025-12-26: Image Display Bug (Missing / Mismatch)

## 日付 / Date
- 2025-12-26

## 概要 / Summary
- ディレクトリ指定で起動後、キー長押しで高速移動するとまれに画像が表示されない、または別画像が表示される問題が発生。
- ステータスの●が緑 (Ready) でも画像が空のケースがあり、`r` でリロードすると表示される。

## 症状 / Symptoms
- Ready 表示だが画像が表示されない (空白)。
- 表示領域だけ合っていて、別画像がその領域に出る。

## 再現条件 / Steps
1. 画像ディレクトリを指定して起動。
2. `j` / `k` を長押しして高速移動。
3. まれに Ready 表示なのに画像が空白、または別画像が出る。
4. `r` でリロードすると表示される。

## 調査 / Investigation
- `SIVIT_TRACE_WORKER=1` で `/tmp/sivit_worker.log` を確認。
- 問題発生時でも該当ファイルは `decode/resize/encode` が完了している記録があり、ワーカー側は正常。

## 原因 / Root Cause
1) **KGP プレースホルダ色の衝突**
   - 画像 ID を連番で割り当てていたため、RGB が極端に低い値 (例: 0x010101) になりやすい。
   - 端末側の色量子化で ID が衝突し、別画像が表示される現象が発生。
2) **端末側キャッシュのエビクション**
   - 画像データは端末側に保持される前提で `ImagePlace` を行う。
   - 高速移動時に端末側が古い画像を破棄してしまうと、place-only では表示されず空白になる。
   - `r` で再送すると復旧することから、この挙動が濃厚。

## 対応 / Fix
- **古い描画タスクの無視**:
  - 連続ナビゲーション時の古い描画結果を無視するため、世代 (epoch) を導入。
  - 対象: `src/app.rs`, `src/sender.rs`
- **KGP ID の分散化**:
  - 24bit 空間で ID を分散し、RGB 各成分が一定以上になるよう割り当て。
  - 低輝度による ID 衝突を回避。
  - 対象: `src/app.rs`
- **再送フェイルセーフ**:
  - 一定数以上の送信を経た古いキャッシュは再送して端末側のエビクションに対応。
  - `status_indicator` も同判定で Busy にする。
  - 対象: `src/app.rs`

## 影響範囲 / Affected Files
- `src/app.rs`
- `src/sender.rs`

## 検証 / Validation
- `cargo check` 実行済み。
- 変更後、画像ズレは解消。
- 画像未表示についても現時点では再発なし。

## 追加メモ / Notes
- もし再発する場合は、writer 側の送信/キャンセルをログ化して再確認する。
